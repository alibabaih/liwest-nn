var Kunena=new Class({initialize:function(){}});Kunena.Uploader=new Class({options:{runtimes:"gears,html5,flash,silverlight,browserplus",url:"",dragdrop:true,multiple_queues:true,buttons:{browse:true,start:true,stop:true},autostart:true,max_file_count:0},contents_bak:"",FILE_COUNT_ERROR:-9001,initialize:function(c,b){var a=this,e,d;this.options=$merge(this.options,b);this.element=document.id(c);e=this.element.get("id");if(!e){e=plupload.guid();this.element.set("id",e);}this.id=e;this.contents_bak=this.element.get("html");this._render(c);this.container=this.element.getElement(".upload-container").set("id",e+"_container");this.filelist=this.container.getElement(".upload-filelist-files").set({id:e+"_filelist",unselectable:"on"});this.browse_button=this.container.getElement(".upload-button-add").set("id",e+"_browse");this.start_button=this.container.getElement(".upload-button-start").set("id",e+"_start").set("style","display: none");this.stop_button=this.container.getElement(".upload-button-stop").set("id",e+"_stop").set("style","display: none");this.counter=this.element.getElement(".upload-count").set({id:e+"_count",name:e+"_count"});d=this.uploader=new plupload.Uploader($merge({container:e,browse_button:e+"_browse"},this.options));d.bind("Init",function(f,g){if(a.uploader.features.dragdrop&&a.options.dragdrop){a._enableDragAndDrop();}a.container.set("title","Using runtime: "+(a.runtime=g.runtime));a.start_button.addEvent("click",function(h){a.start();h.preventDefault();});a.stop_button.addEvent("click",function(h){a.stop();h.preventDefault();});});d.init();if(this.options.max_file_count){d.bind("FilesAdded",function(f,h){var i=[],g=h.length;var j=f.files.length+g-a.options.max_file_count;if(j>0){i=h.splice(g-j,j);f.trigger("Error",{code:a.FILE_COUNT_ERROR,message:"File count error.",file:i});}});}d.bind("FilesAdded",function(f,g){if(a.options.autostart){a.start();}});d.bind("FilesRemoved",function(f,g){});d.bind("QueueChanged",function(){a._updateFileList();a._handleState();});d.bind("StateChanged",function(){a._handleState();});d.bind("UploadFile",function(f,g){a._handleFileStatus(g);});d.bind("ChunkUploaded",function(g,h,f){a._handleErrors(h,f);});d.bind("FileUploaded",function(g,h,f){a._handleErrors(h,f);a._handleFileStatus(h);});d.bind("UploadProgress",function(f,g){a.element.getElement("#"+g.id+" .upload-file-status").getElement(".bar").set("style","width: "+g.percent+"%");if(g.percent<100){a.element.getElement("#"+g.id+" .upload-file-status").getElement(".bar-label").set("text",g.percent+"%");}else{a.element.getElement("#"+g.id+" .upload-file-status").getElement(".bar-label").set("text","Completed "+g.percent+"%");}a._handleFileStatus(g);a._updateTotalProgress();});d.bind("UploadComplete",function(f,g){});d.bind("Error",function(f,j){var h=j.file,i,g;if(h){i="<strong>"+j.message+"</strong>";g=j.details;if(g){i+=" <br /><i>"+j.details+"</i>";}else{switch(j.code){case plupload.FILE_EXTENSION_ERROR:g="File: %s".replace("%s",h.name);break;case plupload.FILE_SIZE_ERROR:g="File: %f, size: %s, max file size: %m".replace(/%([fsm])/g,function(l,k){switch(k){case"f":return h.name;case"s":return h.size;case"m":return plupload.parseSize(a.options.max_file_size);}});break;case a.FILE_COUNT_ERROR:g="Upload element accepts only %d file(s) at a time. Extra files were stripped.".replace("%d",a.options.max_file_count);break;case plupload.IMAGE_FORMAT_ERROR:g=plupload.translate("Image format either wrong or not supported.");break;case plupload.IMAGE_MEMORY_ERROR:g=plupload.translate("Runtime ran out of available memory.");break;case plupload.IMAGE_DIMENSIONS_ERROR:g=plupload.translate("Resoultion out of boundaries! <b>%s</b> runtime supports images only up to %wx%hpx.").replace(/%([swh])/g,function(l,k){switch(k){case"s":return f.runtime;case"w":return f.features.maxWidth;case"h":return f.features.maxHeight;}});break;case plupload.HTTP_ERROR:g="Upload URL might be wrong or doesn't exist";break;}i+=" <br /><i>"+g+"</i>";}a.notify("error",i);}});},start:function(){this.uploader.start();},stop:function(){this.uploader.stop();},getFile:function(b){var a;if(typeof b==="number"){a=this.uploader.files[b];}else{a=this.uploader.getFile(b);}return a;},removeFile:function(b){var a=this.getFile(b);if(a){this.uploader.removeFile(a);}},clearQueue:function(){this.uploader.splice();},getUploader:function(){return this.uploader;},refresh:function(){this.uploader.refresh();},notify:function(b,c){var a=new Element("div",{html:'<div class="upload-icon upload-close" title="Close"></div><p><span class="upload-icon"></span>'+c+"</p>"});a.addClass("upload-"+(b==="error"?"error":"highlight"));a.getElements("p .upload-icon").addClass("upload-"+(b==="error"?"alert":"info"));a.getElements(".upload-close").addEvent("click",(function(d){a.destroy();d.preventDefault();}));this.container.grab(a,"top");},_render:function(a){document.id(a).set("html",'<div class="innerspacer kbox-full"><div class="upload-container"><div class="upload-filelist-container"><table class="upload-filelist kbox-full kbox-border kbox-border_radius kbox-border_radius-vchild kbox-shadow"><thead class="upload-filelist header"><tr class="upload-filelist-header kbox-hover_header-row"><th class="upload-file-name"><span class="bold">File Name</span></th><th class="upload-file-status"><span class="bold">Status</span></th><th class="upload-file-size"><span class="bold">Size</span></th><th class="upload-file-action"></th></tr></thead><tbody class="upload-filelist-files"></tbody><tfoot class="upload-filelist-bottom"><tr class="upload-filelist-footer kbox-hover_header-row"><td class="upload-file-name upload-upload-status"><span class="upload-status-label bold"></td><td class="upload-file-status upload-total-status"><div class="progress progress-striped active"><div class="bar"><span class="bar-label bold">0%</span></div></div></td><td class="upload-file-size upload-total-file-size"><span class="total-file-size-label bold">0kb</span></td><td class="upload-file-action"></td></tr></tfoot></table></div><div class="upload-buttons innerspacer"><ul class="buttonbar buttons-category"><li class="item-button"><a class="kbutton button-type-standard upload-button-add">Add Files</a></li><li class="item-button"><a class="kbutton button-type-standard upload-button-start"><span>Start Upload</span></a></li><li class="item-button"><a class="kbutton button-type-standard upload-button-stop"><span>Stop Upload</span></a></li></ul></div><input class="upload-count" value="0" type="hidden" /></div></div>');},_handleErrors:function(d,a){var c=this,e=this.uploader;var b=JSON.decode(a.response,true);if(!b||!b.success){d.status=plupload.FAILED;c.notify("error",(b&&b.error?b.error:"Unknown response error!")+"<br />File: "+d.name);}},_handleState:function(){var a=this,b=this.uploader;if(b.state===plupload.STARTED){a.start_button.set("style","display: none");if(this.options.buttons.stop===true){a.stop_button.set("style","display: block");}}else{a.stop_button.set("style","display: none");if(this.options.buttons.start===true&&b.total.queued>0){a.start_button.set("style","display: block");}a._updateFileList();}},_handleFileStatus:function(b){var d,a;switch(b.status){case plupload.DONE:d="upload-file upload-done";a="upload-icon upload-check";break;case plupload.FAILED:d="upload-file upload-failed";a="upload-icon upload-alert";break;case plupload.QUEUED:d="upload-file upload-delete";a="upload-icon upload-minus";break;case plupload.UPLOADING:d="upload-file upload-uploading";a="upload-icon upload-arrow";break;}var c=document.id(b.id);if(c){c.set("class",d).getElements(".upload-icon").set("class",a);}},_updateTotalProgress:function(){var a=this.uploader;this.element.getElement(".upload-total-status").getElement(".bar").set("style","width: "+a.total.percent+"%");if(a.total.percent<100){this.element.getElement(".upload-total-status").getElement(".bar-label").set("text",a.total.percent+"%");}else{this.element.getElement(".upload-total-status").getElement(".bar-label").set("text","Completed "+a.total.percent+"%");}this.element.getElement(".upload-upload-status").getElement(".upload-status-label").set("text","Uploaded "+a.total.uploaded+"/"+a.files.length+" files");if(a.total.queued===0){this.browse_button.set("html","<span>Add Files</span>");}else{this.browse_button.set("html","<span>"+"%d files queued".replace("%d",a.total.queued)+"</span>");}},_updateFileList:function(){var b=this,g=this.uploader,e=this.filelist,d=0,h,f=this.id+"_",a;e.empty();Array.each(g.files,function(j){a="";h=f+d;if(j.status===plupload.DONE){if(j.target_name){a+='<input type="hidden" name="'+h+'_tmpname" value="'+plupload.xmlEncode(j.target_name)+'" />';}a+='<input type="hidden" name="'+h+'_name" value="'+plupload.xmlEncode(j.name)+'" />';a+='<input type="hidden" name="'+h+'_status" value="'+(j.status===plupload.DONE?"done":"failed")+'" />';d++;b.counter.set("value",d);}var i=new Element("tr",{"class":"upload_file",id:j.id,html:'<td class="upload-file-name"><span>'+j.name+'</span></td><td class="upload-file-status"><div class="progress progress-striped active"><div class="bar"><span class="bar-label bold">'+j.percent+'%</span></div></div></td><td class="upload-file-size">'+plupload.formatSize(j.size)+'</td><td class="upload-file-action"><div class="upload-icon" title="Remove File"></div>'+a+"</td>"});e.grab(i);b._handleFileStatus(j);$$("#"+j.id+" .upload-icon").addEvent("click",function(k){document.id(j.id).destroy();g.removeFile(j);b._handleState();if(j.status==plupload.UPLOADING){b.stop();b.start();}k.preventDefault();});});b.element.getElement(".upload-total-file-size").getElement(".total-file-size-label").set("text",plupload.formatSize(g.total.size));if(g.features.dragdrop&&g.settings.dragdrop){var c=new Element("tr",{"class":"kbox-hover_list-row",html:'<td colspan="4" class="upload-droptext">Drag files here.</td>'});this.filelist.grab(c);}b._updateTotalProgress();},_enableDragAndDrop:function(){this._updateFileList();this.filelist.getParent().set("id",this.id+"_dropbox");this.uploader.settings.drop_element=this.options.drop_element=this.id+"_dropbox";}});